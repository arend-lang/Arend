\open ::LC::Term
\open ::LC::Ctx
\open ::LC::Properties
\open ::LC::RVec

\open ::Data::Either
\open ::Data::Bool
\open ::Data::Nat::Base
\open ::Data::Unit


\function
(==) (n m : Nat) : Bool <= \elim n, m
    | zero, zero    => true
    | zero, suc _   => false
    | suc _, zero   => false
    | suc n, suc m  => n == m


\function
isFree
    (x : Nat)
    (t : NTerm) : Bool <= \elim t
        | NVar v        => x == v
        | NApp t1 t2    => (isFree x t1) `or` (isFree x t2)
        | NLam v t      => if (v == x) false (isFree x t)



{-
-- termination checker =(
\function
nsubst
    (t1 : NTerm)
    (x : Nat)
    (t2 : NTerm) : NTerm <= \elim t1
        | NVar v    => if (v == x) t2 (NVar v)
        | NApp m n  => NApp (nsubst m x t2) (nsubst n x t2)
        | NLam v t  => if (v == x) (NLam v t) (if (isFree v t2) (nsubst (NLam (suc v) (nsubst t v (NVar (suc v)))) x t2 ) (NLam v (nsubst t x t2)))
-}




\function
isubst
    {n m : Nat}
    (t : ITerm n)
    (ts : RVec n (ITerm m)) : ITerm m <= \elim t
        | IVar i        => ts !! i
        | IApp t1 t2    => IApp (isubst t1 ts) (isubst t2 ts)
        | ILam t        => ILam {?}


\function
fmap
    {V W : \Type}
    (f : V -> W)
    (t : FTerm V) : FTerm W <= \elim t
        | FVar v        => FVar (f v)
        | FApp t1 t2    => FApp (fmap f t1) (fmap f t2)
        | FLam t        => FLam (fmap (map-inl f) t)

\function
return
    {V : \Type}
    (v : V) : FTerm V => FVar v


-- Something like Fun n, but parametrized with some type
-- God damn it, i have no idea how to name these types
\function
Telescope
    (n : Nat)
    (V : \Type) : \Type <= \elim n
        | zero  => V
        | suc n => Either (Telescope n V) Unit


\function
fmap-telescope-helper
    {V W : \Type}
    (n : Nat)
    (f : V -> W)
    (x : Either (Telescope n V) Unit) : Either (Telescope n W) Unit <= \elim x
        | inl y     => inl (fmap-telescope n f y)
        | inr unit  => inr unit


\function
fmap-telescope
    {V W : \Type}
    (n : Nat)
    (f : V -> W)
    (x : Telescope n V) : Telescope n W <= \elim n
        | zero  => f x
        | suc n => fmap-telescope-helper n f x


-- T is for Telescope
\function
    twistT-helper
    {V : \Type}
    (n : Nat)
    (t : Either (Telescope n (FTerm V)) Unit) : FTerm (Either (Telescope n V) Unit) <= \elim t
        | inl x => fmap {Telescope n V} {Either (Telescope n V) Unit} inl (twistT n x)
        | inr unit => FVar (inr unit)


\function
twistT
    {V : \Type}
    (n : Nat)
    (x : Telescope n (FTerm V)) : FTerm (Telescope n V) <= \elim n
        | zero  => x
        | suc n => twistT-helper n x


\function
bind-helper
    {V W : \Type}
    (n : Nat)
    (t : FTerm (Telescope n V))
    (k : V -> FTerm W) : FTerm (Telescope n W) <= \elim t
        | FVar x        => twistT n (fmap-telescope n k x)
        | FApp t1 t2    => FApp (bind-helper n t1 k) (bind-helper n t2 k)
        | FLam t        => FLam (bind-helper (suc n) t k)


\function
bind
    {V W : \Type}
    (t : FTerm V)
    (k : V -> FTerm W) : FTerm W => bind-helper zero t k
