\open ::LC::Subst::Subst
\open ::LC::Term
\open ::LC::RVec

\open ::Data::Bool
\open ::Data::Either
\open ::Data::Empty
\open ::Data::Fin
\open ::Data::Nat::Base
\open ::Data::Nat::Compare
\open ::Data::Unit
\open ::Logic
\open ::Paths


-- All named stuff
{-
\function
nsubst-right-unit-var-helper
    (y x : Nat)
    (d : Dec (y = x)) : var-helper y x d (NVar x) (NVar y) = NVar y <= \elim d
        | inr pro       => pmap NVar (inv pro)
        | inl contra    => idpe (NVar y)


\function
nsubst-right-unit-lam-helper
    (y x : Nat)
    (t : NTerm)
    (dv : Dec (y = x)) : lam-helper y (NVar x) (var-helper-is-free-dec y x dv) (NLam (suc y) (nsubst' t x (NVar x) (\lam z => \case z =? y | inr p => suc y | inl np => z))) (NLam y (nsubst' t x (NVar x) (\lam x' => x'))) = NLam y t <= \elim dv
        | inr pro       => transport (\lam k => lam-helper x (NVar x) (var-helper-is-free-dec x x (x =? x)) (NLam (suc x) (nsubst' t x (NVar x) (\lam z => (\case z =? k | inr _ => suc k | inl _ =>  z)))) (NLam x (nsubst' t x (NVar x) (\lam x  => x))) = NLam x t) (inv pro) (nsubst-right-unit (NLam x t) x)
        | inl contra    => pmap (NLam y) (nsubst-right-unit t x)


\function
nsubst-right-unit
    (t : NTerm)
    (x : Nat) : nsubst t x (NVar x) = t <= \elim t
        | NVar y        => nsubst-right-unit-var-helper y x (y =? x)
        | NApp t1 t2    => pmap2 NApp (nsubst-right-unit t1 x) (nsubst-right-unit t2 x)
        | NLam y t      => nsubst-right-unit-lam-helper y x t (y =? x)
-}

\function
nsubst-left-unit-helper
    (x : Nat)
    (d : Dec (x = x))
    (t : NTerm) : var-helper x x d t (NVar x) = t <= \elim d
        | inr idp       => idpe t
        | inl contra    => absurd (contra (idpe x))


\function
nsubst-left-unit
    (x : Nat)
    (t : NTerm) : nsubst (NVar x) x t = t => nsubst-left-unit-helper x (x =? x) t


\function
nsubst-assoc-var-helper
    (v x y : Nat)
    (d1 : Dec (v = x))
    (d2 : Dec (v = y))
    (M N : NTerm)
    (p : IsFree x M -> Empty) : nsubst (nsubst (NVar v) x N) y M = nsubst (nsubst (NVar v) y M) x (nsubst N y M) <= \elim d1, d2
        | inr pro1, inr pro2 => {?}
        | inr pro1, inl contra2 => {?}
        | inl contra1, inr pro2 => {?}
        | inl contra1, inl contra2 => {?}

\function
nsubst-assoc
    (t : NTerm)
    (x y : Nat)
    (M N : NTerm)
    (p : IsFree x M -> Empty) : nsubst (nsubst t x N) y M = nsubst (nsubst t y M) x (nsubst N y M) <= \elim t
		| NVar v 		=> nsubst-assoc-var-helper v x y (v =? x) (v =? y) M N p
		| NApp t1 t2 	=> pmap2 NApp (nsubst-assoc t1 x y M N p) (nsubst-assoc t2 x y M N p)
		| NLam v t 		=> {?}


\function
gen-vars
    (n : Nat) : RVec n (ITerm n) <= \elim n
        | zero => vnil
        | suc n => snoc (rmap weak (gen-vars n)) (IVar fzero)


\function
identity2 : gen-vars 2 = snoc (snoc  vnil (IVar (fsuc fzero))) (IVar fzero) => idp

\function
identity3 : gen-vars 3 = snoc (snoc (snoc  vnil (IVar (fsuc (fsuc fzero)))) (IVar (fsuc fzero))) (IVar fzero) => idp


-- All index stuff

\function
isubst-right-unit-weak-lemma
    {n m : Nat}
    (i : Fin n)
    (ts : RVec n (ITerm m)) : (rmap weak ts) !! i = weak (ts !! i) <= \elim n, i, ts
        | suc n, fzero, snoc ts t => idp
        | suc n, fsuc i, snoc ts t => isubst-right-unit-weak-lemma i ts


\function
isubst-right-unit-var-helper
    (n : Nat)
    (i : Fin n) : (gen-vars n) !! i = IVar i <= \elim n, i
        | suc n, fzero => idp
        | suc n, fsuc j =>  \let
                                | p => isubst-right-unit-weak-lemma j (gen-vars n)
                                | rec => isubst-right-unit-var-helper n j
                                | q => transport (\lam x => (rmap weak (gen-vars n)) !! j = weak x) rec p
                            \in transport (\lam x => (rmap weak (gen-vars n)) !! j = x) idp q


\function
isubst-right-unit
    {n : Nat}
    (t : ITerm n) : isubst t (gen-vars n) = t <= \elim t
        | IVar i        => isubst-right-unit-var-helper n i
        | IApp t1 t2    => pmap2 IApp (isubst-right-unit t1) (isubst-right-unit t2)
        | ILam t        => pmap ILam (isubst-right-unit t)


\function
isubst-left-unit
    {n m : Nat}
    (i : Fin n)
    (ts : RVec n (ITerm m)) : isubst (IVar i) ts = ts !! i => idp


\function
isubst-assoc-var-helper
    (n m k : Nat)
    (i : Fin n)
    (ts : RVec n (ITerm m))
    (ss : RVec m (ITerm k)) : isubst (ts !! i) ss = rmap (\lam x => isubst x ss) ts !! i <= \elim n, i, ts
        | suc n, fzero, snoc ts t   => idp
        | suc n, fsuc i, snoc ts t  => isubst-assoc-var-helper n m k i ts ss


\function
isubst-weak-lemma-helper-helper
    {n m : Nat}
    (i : Fin n)
    (ss : RVec n (ITerm m)) : rmap weak ss !! i = weak (ss !! i) <= \elim n, i, ss
        | suc n, fzero, snoc ss s => idp
        | suc n, fsuc i, snoc ss s => isubst-weak-lemma-helper-helper i ss


\function
isubst-weak-lemma-helper
    {n m : Nat}
    (t : ITerm n)
    (ss : RVec n (ITerm m)) : isubst (weak t) (snoc (rmap weak ss) (IVar fzero)) = weak (isubst t ss) <= \elim t
        | IVar i => isubst-weak-lemma-helper-helper i ss
        | IApp t1 t2 => pmap2 IApp (isubst-weak-lemma-helper t1 ss) (isubst-weak-lemma-helper t2 ss)
        | ILam t => pmap ILam (isubst-weak-lemma-helper t (snoc (rmap weak ss) (IVar fzero)))


\function
isubst-weak-lemma
    (n m k : Nat)
    (ts : RVec n (ITerm m))
    (ss : RVec m (ITerm k)) : rmap (\lam x => isubst x (snoc (rmap weak ss) (IVar fzero))) (rmap weak ts) = rmap weak (rmap (\lam x => isubst x ss) ts) <= \elim n, ts
        | zero, vnil => idp
        | suc n, snoc ts t => pmap2 snoc (isubst-weak-lemma n m k ts ss) (isubst-weak-lemma-helper t ss)


\function
isubst-assoc
    {n m k : Nat}
    (t : ITerm n)
    (ts : RVec n (ITerm m))
    (ss : RVec m (ITerm k)) : isubst (isubst t ts) ss = isubst t (rmap (\lam x => isubst x ss) ts) <= \elim t
        | IVar i        => isubst-assoc-var-helper n m k i ts ss
        | IApp t1 t2    => pmap2 IApp (isubst-assoc t1 ts ss) (isubst-assoc t2 ts ss)
        | ILam t        => \let
                                | ts' => snoc (rmap weak ts) (IVar fzero)
                                | ss' => snoc (rmap weak ss) (IVar fzero)
                                | p => isubst-assoc t ts' ss'
                                | pt => transport (\lam x => isubst (isubst t ts') ss' = isubst t x) (pmap2 snoc (isubst-weak-lemma n m k ts ss) idp) p
                            \in pmap ILam pt



-- All monadic stuff
-- Lemmata


\function
twistT-lemma
    {V : \Type}
    (n : Nat)
    (x : Telescope n V) : twistT n (fmap-telescope n FVar x) = FVar x <= \elim n
        | zero => idp
        | suc y => twistT-helper-lemma y x
            \where
                \function
                    twistT-helper-lemma
                    {V : \Type}
                    (n : Nat)
                    (e : Either (Telescope n V) Unit) : twistT (suc n) (fmap-telescope (suc n) FVar e) = FVar e <= \elim e
                        | inr unit => idp
                        | inl a => pmap (fmap inl) (twistT-lemma n a)


\function
return-right-unit-lemma
    {V : \Type}
    (n : Nat)
    (t : FTerm (Telescope n V)) : bind-helper n t return = t <= \elim t
        | FVar x        => twistT-lemma n x
        | FApp t1 t2    => pmap2 FApp (return-right-unit-lemma n t1) (return-right-unit-lemma n t2)
        | FLam t        => pmap FLam (return-right-unit-lemma (suc n) t)

{-
\function
bind-assoc-lemma-fmap-telescope-helper
   {A B C : \Type}
   (n : Nat)
   (f : A -> FTerm B)
   (g : B -> FTerm C)
   (t : Telescope n A) : bind-helper (suc n) (fmap {Telescope n B} {Either (Telescope n B) Unit} inl (twistT n (fmap-telescope n f t))) g =
       fmap {Telescope n C} {Either (Telescope n C) Unit} inl (twistT n (fmap-telescope n (\lam x => (f x) `bind` g) t)) <= \elim n
       | zero => {?}
       | suc n => {?}
-}

\function
bind-assoc-lemma-telescope-helper
    {A B C : \Type}
    (n : Nat)
    (f : A -> FTerm B)
    (g : B -> FTerm C)
    (t : Either (Telescope n A) Unit) : bind-helper (suc n) (twistT (suc n) (fmap-telescope (suc n) f t)) g = twistT (suc n) (fmap-telescope (suc n) (\lam x => (f x) `bind` g) t) <= \elim t
        | inr unit => idp
        | inl t =>  \let
                        | rec => bind-assoc-lemma-var-helper n f g t
                    \in {?} --bind-assoc-lemma-fmap-telescope-helper n f g t


\function
bind-assoc-lemma-var-helper
    {A B C : \Type}
    (n : Nat)
    (f : A -> FTerm B)
    (g : B -> FTerm C)
    (t : Telescope n A) : bind-helper n (twistT n (fmap-telescope n f t)) g = twistT n (fmap-telescope n (\lam x => (f x) `bind` g) t) <= \elim n
        | zero => idp
        | suc n => bind-assoc-lemma-telescope-helper n f g t


\function
bind-assoc-lemma
    {A B C : \Type}
    (n : Nat)
    (f : A -> FTerm B)
    (g : B -> FTerm C)
    (t : FTerm (Telescope n A)) : bind-helper n (bind-helper n t f) g = bind-helper n t (\lam x => (f x) `bind` g) <= \elim t
        | FVar t        => bind-assoc-lemma-var-helper n f g t
        | FApp t1 t2    => pmap2 FApp (bind-assoc-lemma n f g t1) (bind-assoc-lemma n f g t2)
        | FLam t        => pmap FLam (bind-assoc-lemma (suc n) f g t)


-- Proofs

\function
return-right-unit
    {V : \Type}
    (t : FTerm V) : t `bind` return = t => return-right-unit-lemma zero t


\function
return-left-unit
    {V W : \Type}
    (x : V)
    (k : V -> FTerm W) : ((return x) `bind` k = k x) => idp


\function
bind-assoc
    {A B C : \Type}
    (f : A -> FTerm B)
    (g : B -> FTerm C)
    (t : FTerm A) : (t `bind` f) `bind` g = t `bind` (\lam x => (f x) `bind` g) => bind-assoc-lemma zero f g t
